<!DOCTYPE html>
<html data-theme="lofi">
  <!-- some good themes for cool winter, corporate, nord, aqua, lofi, business, dark, dim -->
  <head>
    <meta charset="utf-8" />
    <title>Sensor Panel</title>
    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: white;
        overflow: hidden;
      }

      /* 16:9 cover math */
      .video-cover iframe {
        position: absolute;
        top: 50%;
        left: 50%;

        /* Maintain aspect ratio */
        width: 177.78vh; /* 16 / 9 * 100 */
        height: 100vh;

        min-width: 100vw;
        min-height: 56.25vw; /* 9 / 16 * 100 */

        transform: translate(-50%, -50%);
        border: 0;
      }

      /* Firefox */
      progress#cpu_temp_progress::-moz-progress-bar {
        background-color: var(--cpu-temp-color);
        transition: background-color 300ms linear;
      }

      /* Chromium / WebKit */
      progress#cpu_temp_progress::-webkit-progress-value {
        background-color: var(--cpu-temp-color);
        transition: background-color 300ms linear;
      }

      /* Firefox */
      progress#gpu_temp_progress::-moz-progress-bar {
        background-color: var(--gpu-temp-color);
        transition: background-color 300ms linear;
      }

      /* Chromium / WebKit */
      progress#gpu_temp_progress::-webkit-progress-value {
        background-color: var(--gpu-temp-color);
        transition: background-color 300ms linear;
      }

    </style>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body>
    <div class="video-cover fixed inset-0 overflow-hidden">
      <div id="player"></div>
    </div>

    <div class="fixed inset-0 flex items-center z-50 pointer-events-none">
      <div class="flex flex-col items-start justify-center gap-6 h-full bg-white/35 rounded-2xl px-8 py-2 scale-150 translate-x-28">
        <div class="flex items-center">
          <!-- CPU Power (RADIAL) -->
          <div class="flex flex-col items-center mr-1">
            <div
              id="cpu_util"
              class="radial-progress text-primary bg-secondary/30"
              style="--value:0; --size:5.2rem; --thickness:10px;"
              role="progressbar">
              <span id="cpu_util_text" class="text-lg font-semibold text-base-content/80">--w</span>
            </div>
          </div>

          <!-- CPU STAT -->
          <div class="stat gap-2">
            <div class="stat-figure text-primary p-4">
              <!-- CPU icon -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                class="inline-block size-16 stroke-current">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 2v2M15 2v2M9 20v2M15 20v2M2 9h2M2 15h2M20 9h2M20 15h2M6 6h12v12H6z" />
              </svg>
            </div>

            <div id="cpu_power" class="stat-title text-lg font-semibold">CPU (--W)</div>

            <div class="stat-value text-4xl leading-none">
              <span id="cpu_temp">--</span>
              <span class="text-lg align-top">°C</span>
            </div>

            <div id="" class="stat-desc flex flex-col text-base">
              <progress
                id="cpu_temp_progress"
                class="progress w-48 h-1 mb-2"
                value="0"
                max="95">
              </progress>

              <div id="ram_desc" class="stat-desc text-base">
                RAM --gb/--gb
              </div>

              <progress
                id="ram_progress"
                class="progress progress-primary w-48 h-1"
                value="39"
                max="95">
              </progress>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- GPU UTIL (RADIAL) -->
          <div class="flex flex-col items-center">
            <div
              id="gpu_util"
              class="radial-progress text-primary bg-secondary/30"
              style="--value:0; --size:5.2rem; --thickness:4px;"
              role="progressbar">
              <span id="gpu_util_text" class="text-lg font-semibold text-base-content/80">--°</span>
            </div>
          </div>

          <!-- GPU STAT -->
          <div class="stat">
            <div class="stat-figure text-primary p-4">
              <!-- GPU icon -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                class="inline-block size-16 stroke-current">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16v8H4zM6 14v4h4v-4M14 14v4h4v-4M9 10h.01M12 10h.01M15 10h.01" />
              </svg>
            </div>

            <div id="gpu_power" class="stat-title text-lg font-semibold">GPU</div>

            <div class="stat-value text-4xl leading-none">
              <span id="gpu_hotspot">--</span>
              <span class="text-lg align-top">°C</span>
              <span id="vram_temp" class="text-sm font-normal text-base-content/70">°C</span>
            </div>

            <div id="" class="stat-desc flex flex-col text-base">
              <progress
                id="gpu_temp_progress"
                class="progress progress-error w-48 h-1 mb-2"
                value="0"
                max="110">
              </progress>

              <span id="gpu_desc">VRAM --GB · --°C</span>

              <progress
                id="gpu_progress"
                class="progress progress-primary w-48 h-1"
                value="00"
                max="110">
              </progress>

            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let player;
      let loopTimer;
      const RESTART_THRESHOLD = 0.5; // seconds before end

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          videoId: 'AKfsikEXZHM',
          playerVars: {
            autoplay: 1,
            mute: 1,
            controls: 1,
            rel: 0,
            playsinline: 1,
            origin: 'http://localhost:3000'
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange
          }
        });
      }

      function onPlayerReady(e) {
        e.target.playVideo();
        startLoopGuard();
      }

      function onPlayerStateChange(e) {
        if (e.data === YT.PlayerState.PLAYING) {
          startLoopGuard();
        }

        if (e.data === YT.PlayerState.ENDED) {
          restart();
        }
      }

      function startLoopGuard() {
        stopLoopGuard();
        loopTimer = setInterval(() => {
          const duration = player.getDuration();
          const current = player.getCurrentTime();

          if (duration > 0 && duration - current <= RESTART_THRESHOLD) {
            restart();
          }
        }, 100);
      }

      function stopLoopGuard() {
        if (loopTimer) {
          clearInterval(loopTimer);
          loopTimer = null;
        }
      }

      function restart() {
        stopLoopGuard();
        player.seekTo(0.25, true);
        player.playVideo();
      }

      const API_URL = "/metrics"
      const POLL_INTERVAL_MS = 1000

      async function fetchSensors() {
        try {
          const res = await fetch(API_URL, { cache: "no-store" })
          if (!res.ok) throw new Error("bad response")
          return await res.json()
        } catch (err) {
          console.warn("sensor fetch failed", err)
          return null
        }
      }

      function tempColorForPct(temp, max = 95, min = 35) {
        const clamped = Math.min(Math.max(temp, min), max)

        // Map temp range → hue (blue → red)
        const hue = 220 - ((clamped - min) / (max - min)) * 220

        return `hsl(${hue}, 85%, 55%)`
      }

      function updateUI(data) {
        if (!data) return
        // CPU
        const cpuTemp = Math.round(data.cpu.temp_c)
        const cpuUtil = Math.round(data.cpu.util_pct)
        const cpuPower = Math.round(data.cpu.power_w)
        document.getElementById("cpu_temp").textContent = cpuTemp
        document.getElementById("cpu_power").textContent = `CPU (${cpuPower}W)`

        const cpuTempProgress = document.getElementById("cpu_temp_progress")
        if (cpuTempProgress) {
          cpuTempProgress.value = cpuTemp
          cpuTempProgress.style.setProperty("--cpu-temp-color", tempColorForPct(cpuTemp))
        }

        const cpuRadial = document.getElementById("cpu_util")
        cpuRadial.style.setProperty("--value", cpuUtil)
        document.getElementById("cpu_util_text").textContent = `${cpuUtil}%`


        // GPU
        const gpuEdge = Math.round(data.gpu.edge_c)
        const gpuHotspot = Math.round(data.gpu.hotspot_c)
        const gpuUtil = Math.round(data.gpu.util_pct)
        const gpuVramTemp = Math.round(data.gpu.vram_c)
        const gpuVramTotal = Math.round(data.gpu.vram_total_gb * 10) / 10
        const gpuVramUsed = Math.round(data.gpu.vram_used_gb * 10) / 10
        const gpuVramUsedPct = Math.round(data.gpu.vram_used_pct)
        const gpuPower = Math.round(data.gpu.power_w)

        document.getElementById("gpu_hotspot").textContent = gpuHotspot
        document.getElementById("vram_temp").textContent = `VRAM ${gpuVramTemp}°C`
        document.getElementById("gpu_desc").textContent = `VRAM ${gpuVramUsed}/${gpuVramTotal}GB (${gpuVramUsedPct}%)`
        document.getElementById("gpu_progress").value = gpuVramUsedPct
        document.getElementById("gpu_power").textContent = `GPU (${gpuPower}W)`

        const gpuTempProgress = document.getElementById("gpu_temp_progress")
        if (gpuTempProgress) {
          gpuTempProgress.value = gpuHotspot
          gpuTempProgress.style.setProperty("--gpu-temp-color", tempColorForPct(gpuHotspot, 110, 45))
        }

        const radial = document.getElementById("gpu_util")
        radial.style.setProperty("--value", gpuUtil)
        document.getElementById("gpu_util_text").textContent = `${gpuUtil}%`

        // RAM
        const ramTotal = Math.round(data.ram.total_gb * 10) / 10;
        const ramUsed = Math.round(data.ram.used_gb * 10) / 10;
        const ramAvail = Math.round(data.ram.avail_gb * 10) / 10;
        const ramUsedPct = Math.round(data.ram.used_pct * 10) / 10;

        document.getElementById("ram_progress").value = ramUsedPct
        document.getElementById("ram_desc").textContent = `RAM ${ramUsed}/${ramTotal}gb (${ramUsedPct}%)`
      }

      async function poll() {
        const data = await fetchSensors()
        updateUI(data)
      }

      setInterval(poll, POLL_INTERVAL_MS)
      poll()
    </script>
  </body>
</html>
